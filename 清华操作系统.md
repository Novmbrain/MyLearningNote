# 清华操作系统

# 第一讲：启动、中断、异常和系统调用

## BIOS

**启动时计算机内存和磁盘的布局**

![image-20210621235659056](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210621235659056-1624312620728.png)

当计算机加电后，一般不直接执行操作系统，而是执行系统初始化软件完成基本IO初始化和引导加载功能。简单地说，系统初始化软件就是在操作系统内核运行之前运行的一段小软件。通过这段小软件，我们可以初始化硬件设备、建立系统的内存空间映射图，从而将系统的软硬件环境带到一个合适的状态，以便为最终调用操作系统内核准备好正确的环境。最终引导加载程序把操作系统内核映像加载到RAM中，并将系统控制权传递给它。

![image-20210621235752960](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210621235752960-1624312675636.png)

对于Intel 80386的体系结构而言，PC机中的系统初始化软件由BIOS (Basic Input Output System，即基本输入/输出系统，其本质是一个固化在主板Flash/CMOS上的软件)和位于软盘/硬盘引导扇区中的OS Boot Loader（在ucore中的bootasm.S和bootmain.c）一起组成。BIOS实际上是被固化在计算机ROM（只读存储器）芯片上的一个特殊的软件，为上层软件提供最底层的、最直接的硬件控制与支持

以Intel 80386为例，计算机加电后，CPU从物理地址0xFFFFFFF0（由初始化的CS：EIP确定，此时CS和IP的值分别是0xF000和0xFFF0)）开始执行。在0xFFFFFFF0这里只是存放了一条跳转指令，通过跳转指令跳到BIOS例行程序起始点。BIOS做完计算机硬件自检和初始化后，会选择一个启动设备（例如软盘、硬盘、光盘等），并且读取该设备的第一扇区(即主引导扇区或启动扇区)到内存一个特定的地址0x7c00处，然后CPU控制权会转移到那个地址继续执行。至此BIOS的初始化工作做完了，进一步的工作交给了ucore的bootloader。

## 中断 异常 和 系统调用

中断：来自硬件设备的处理请求

异常：非法指令或者其他原因导致当前指令执行失败

系统调用：应用程序主动向操作系统发出的服务请求

可以通过请求的源头和响应方式和处理机制区分这三者

源头区分

- 中断：外设
- 异常：应用程序意想不到的行为
- 系统调用：应用程序请求操作提供服务

响应方式

- 中断：异步（不会等待中断）
- 异常：同步（处理完异常才会继续做其他事）
- 系统调用：异步或者同步

处理机制

- 中断：持续的进行，对用户应用程序是透明的
- 异常：杀死或者重新执行意想不到的应用程序指令
- 系统调用：等待和持续



**内核的进入和退出**

![image-20210622173621729](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210622173621729.png)

**中断嵌套**

![image-20210622174733312](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210622174733312.png)

## 系统调用

应用程序代用printf()时，触发系统掉用write()

![image-20210622175019111](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210622175019111.png)

- 系统调用是提供操作系统服务的接口
- 程序访问通常是通过高层次的API结构进行使用系统调用

**系统调用的实现**

![image-20210622175919471](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210622175919471.png)

**函数调用和系统调用的不同之处**

在执行系统调用时，会从普通的堆栈切换到系统的堆栈，并且进行特权级别的转换。

![image-20210622180228122](%E6%B8%85%E5%8D%8E%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F.assets/image-20210622180228122.png)
