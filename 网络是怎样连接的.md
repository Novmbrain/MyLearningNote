# 网络是怎样连接的





## 1.1 生成HTTP请求消息

### 术语集合

#### URL

**URL 代表着是统一资源定位符（***Uniform Resource Locator***）**。URL 无非就是一个给定的独特资源在 Web 上的地址。理论上说，每个有效的 URL 都指向一个唯一的资源。这个资源可以是一个 HTML 页面，一个 CSS 文档，一幅图像，等等。而在实际中，也有一些例外，最常见的情况就是一个 URL 指向了不存在的或是被移动过的资源。由于通过 URL 呈现的资源和 URL 本身由 Web 服务器处理，因此 web 服务器的拥有者需要认真地维护资源以及与它关联的URL。

#### CGI程序

CGI 程序：对Web 服务器程序调用其他程序的规则所做的定义就是CGI， 而按照 CGI 规范来工作的程序就称为 CGI 程序

### 浏览器解析URL

当我们在浏览器上方输入URL时，浏览器会首先对URL进行解析，然后生成请求并将请求发送给Web服务器

![浏览器解析URL](D:\编程学习\MD笔记\网络是怎么样连接的\浏览器解析URL.png)

URL的省略写法

- http://www.lab.glasscom.com/dir/：这代表/dir/后面本应该有的文件名被省略，将访问服务器上事先设置的文件名省略时的默认访问文件名
- http://www.lab.glasscom.com/：这代表访问根目录“/”下的默认访问文件
- ）http://www.lab.glasscom.com/whatisthis：这种写法本身是错误的，一般来说，这种情况会按照下面的惯例进行处理：如果 Web 服务器上存在名为whatisthis的文件，则将whatisthis作为文件名来处 理；如果存在名为whatisthis的目录，则将whatisthis作为目录名来处理

### HTTP协议概览

Hypertext Transfer Protocol，超文本传输协议。它定义了客户端和服务器之间交互的消息内容和步骤

![HTTP协议的基本思路](D:\编程学习\MD笔记\网络是怎么样连接的\HTTP协议的基本思路.png)

请求消息分为“对什么”和“进行怎样的操作”两个部分

- URI：Uniform Resource Identifier，统一资源标识符。“对什么”部分，，URI的内容是一个存放网页 数据的文件名或者是一个CGI 程序 的文件名
- 方法，“进行怎么样的操作部分”

Web服务器在接收到请求消息后进行处理，并将处理结果存放在响应消息中返回

- 状态码：在响应消息的开头有一个状态码， 它用来表示操作的执行结果是成功还是发生了错误。当我们访问Web 服务器时，遇到找不到的文件就会显示出404 Not Found的错误信息，其实这 就是状态码

### GET方法与POST方法

- GET方法：首先，在请求消息中写上GET方法， 然后在URI中写上存放网页数据的文件名“/dir1/file1.html”， 这就表示我 们需要获取/dir1/file1.html文件中的数据。当Web 服务器收到消息后，会 打开/dir1/file1.html文件并读取出里面的数据，然后将读出的数据存放到 响应消息中，并返回给客户端。最后，客户端浏览器会收到这些数据并显 示在屏幕上
- POST方法：使用POST方法时，URI会指向Web 服务 器中运行的一个应用程序 B 的文件名，典型的例子包括“index.cgi”“ index. php”等。然后，在请求消息中，除了方法和URI之外，还要加上传递给 应用程序和脚本的数据。这里的数据也就是用户在输入框里填写的信息。 当服务器收到消息后，Web 服务器会将请求消息中的数据发送给URI指定 的应用程序。最后，Web 服务器从应用程序接收输出的结果，会将它存放 到响应消息中并返回给客户端。 

 ### 生成HTTP请求消息

- 请求消息的第一行中的方法取决于浏览器的工作状态。
  - 在地址栏中输入网址并显示网页，因此这里应该使用GET 方法。
  - 点击超级链接的场景中也是使用GET方法。
  - 如果是表单，在HTML 源代码中会在表单的属性中指定使用哪种方法来发送请求，可能是GET也 可能是POST（GET 方法能够发送的数据只有几百个字节，如果表单中的数据超过这一长 度，则必须使用 POST 方法来发送）
- 消息头：消息头的规格中定义了很多项目，如日期、客户端支持的 数据类型、语言、压缩格式、客户端和服务器的软件名称和版本、数据有 效期和最后更新时间等

![HTTP消息格式](D:\编程学习\MD笔记\网络是怎么样连接的\HTTP消息格式.png)

**以表单提交的方法举例进行讲解**

![HTTP表单提交请求消息](D:\编程学习\MD笔记\网络是怎么样连接的\HTTP表单提交请求消息.png)

### 收到Web服务器的响应

HTTP响应状态码概要

![1.1.4HTTP响应状态码概要](D:\编程学习\MD笔记\网络是怎么样连接的\1.1.4HTTP响应状态码概要.PNG)

由于每条请求消息中只能写1 个 URI，所以每次只能获取1 个文件， 如果需要获取多个文件，必须对每个文件单独发送1 条请求。比如1 个 网页中包含3张图片，那么获取网页加上获取图片，一共需要向Web 服务 器发送4条请求。

![1.1.5HTML请求的响应](D:\编程学习\MD笔记\网络是怎么样连接的\1.1.5HTML请求的响应.PNG)

## 1.2 向DNS服务器查询Web服务器的IP地址

### IP地址

IP地址是一串 32比特的数字，按照8比特（1字节）为一组分成4组，分别用十进制表示 然后再用圆点隔开。网络号和主机号连起来总共是32比特，但这两部分的具体结构是不固 定的

![1.2.1IP地址表示](D:\编程学习\MD笔记\网络是怎么样连接的\1.2.1IP地址表示.PNG)

主机号部分的比特全部为0或者全部为1时代表两种特殊 的含义。主机号部分全部为0代表整个子网而不是子网中的某台设备（图 1.9（d））。 此外，主机号部分全部为1代表向子网上所有设备发送包，即广 播

- IP地址内容短，传输效率高，不好记忆
- 域名长度长且不固定，传输与处理效率低，好记忆

补充：IP 地址不是分配给每一台设备的，而是分配给设备中安装的网 络硬件的。因此，如果一台设备中安装了多个网络硬件，那么就会有多个 IP 地址。

### Socket库查询IP地址

向DNS服务器发出查询，也就是向DNS服务器发送查询消息，并接 收服务器返回的响应消息。我们的电脑上有DNS客户端，也称为DNS解析器。通过DNS查询IP地址的操作称为域名解析，因此 负责执行解析（resolution）这一操作的就叫解析器（resolver）了

Socket库也是一种库，其中包含的程序组件可以让其他的应用程序调用操作系统的网络功能 A，而解析器就是这个库中 的其中一种程序组件。

通过Socket库中的解析器可以向DNS服务器发出查询。具体来说，在编写浏览器等应用程序的时候，只 要像图1.11这样写上解析器的程序名称“gethostbyname”以及Web 服务器 的域名“www.lab.glasscom.com”就可以了，这样就完成了对解析器的调用 B。

![1.2.4调用解析器](D:\编程学习\MD笔记\网络是怎么样连接的\1.2.4调用解析器.PNG)

根据域名查询 IP 地址时，浏览器会使用 Socket 库中的解析器。

![1.2.2Socket库解析器工作流程](D:\编程学习\MD笔记\网络是怎么样连接的\1.2.2Socket库解析器工作流程.PNG)

协议栈：操作系统内部的网络控制软件，也叫做“协议驱动”“TCP/IP驱动”

### DNS服务器如何工作

DNS服务器的基本工作就是接收来自客户端的查询消息，然后根据消息的内容返回响应。DNS 服务器会从域名与 IP 地址的对照表中查找相应的记录，并返回 IP 地址

在域名中，越靠右的 位置表示其层级越高，比如www.lab.glasscom.com这个域名如果按照公司 里的组织结构来说，大概就是“com事业集团glasscom部lab科的www” 这样。其中，相当于一个层级的部分称为域。因此，com 域的下一层是 glasscom域，再下一层是lab域，再下面才是www这个名字。我们可以在域的下面创建下级域 

DNS服务器中的所有信息都是按照域名以分层次的结构来保存的，每个域的信息都存放在相应层级的DNS服务器中。

![1.2.3DNS服务器之间的查询操作](D:\编程学习\MD笔记\网络是怎么样连接的\1.2.3DNS服务器之间的查询操作.PNG)

根域的DNS服务器信息保存在互联网中所有的DNS服务器中。这样一来，任何DNS服务器就都可以找到并访问根域DNS服务器了。因此，客户端只要能够找到任意一台 DNS服务器，就可以通过它找到根域DNS服务器，然后再一路顺藤摸瓜 找到位于下层的某台目标DNS服务器（图1.15）。

实际上，DNS服务器可以管理多个域的信息，同时DNS服务器中有过去查询信息的缓存，可以加快查询速度。DNS服务器中保存的信息都设置有一个有效期，当缓存中的信息超过有效期后，数 据就会从缓存中删除。而且，在对查询进行响应时，DNS服务器也会告知客 户端这一响应的结果是来自缓存中还是来自负责管理该域名的DNS服务器。

## 1.3 委托协议栈发送消息

向操作系统内部的协议栈发出委托时，需要按照指定的顺序来调 用 Socket 库中的程序组件。

首先，服务器一方 先创建套接字，然后等待客户端向该套接字连接管道 A。当服务器进入等待状态时，客户端就可以连接管道了。管道在连接时是由客户端发起的，但在断开 时可以由客户端或服务器任意一方发起 A。其中一方断开后，另一方也会随之 断开，当管道断开后，套接字也会被删除。到此为止，通信操作就结束了。

收发数据的操作的四个阶段

1. 创建套接字（创建套接字阶段）
2. 将管道连接到服务器端的套接字上（连接阶段）
3. 收发数据（通信阶段）
4. 断开管道并删除套接字（断开阶段）

![1.3.1套接字管道示意图](D:\编程学习\MD笔记\网络是怎么样连接的\1.3.1套接字管道示意图.PNG)

在每个阶段，Socket库中的程序组件都会被调用来执行相关的数据收发操作。前面这4 个操作都是由操作系统中的协议栈来执行的，浏览器等应用程序并不会自 己去做连接管道、放入数据这些工作，而是委托协议栈来代劳

### 创建套接字阶段

访问DNS服务器时我们调用的是一个叫作gethostbyname的 程序组件（也就是解析器）， 而这一次则需要按照一定的顺序调用若干个程序组件（这些组件都在socket库中）

首先是套接字创建阶段。客户端创建套接字的操作非常简单，只要调 用Socket库中的socket程序组件 A 就可以了。 和调用解析器一 样，调用socket之后，控制流程会转移到socket内部并执行创建套接字的 操作，完成之后控制流程又会被移交回应用程序。

套接字创建完成后，协议栈会返回一个描述符，应用程序会将收到的 描述符存放在内存中。描述符是用来识别不同的套接字的

应用程序是通过“描述符”这一类似号码牌的东西来识别套接字的。 应用程序是通过“描述符”这一类似号码牌的东西来识别各自对应的套接字的。

![1.3.2客户端和服务器之间收发数据操作的情形](D:\编程学习\MD笔记\网络是怎么样连接的\1.3.2客户端和服务器之间收发数据操作的情形.PNG)

### 连接阶段：把管道接上去

我们需要委托协议栈将客户端创建的套接字与服务器那边的套接字连接起来。应用程序通过调用Socket库中的名为connect的程序组件来完成这一操作。这里的要点是当调用connect 时，需要指定描述符、 服务器IP地址和端口号

- 描述符：就是在创建套接字的时候由协议栈返回的那个描述符。connect会将应用程序指定的描述符告知协议栈，然后协议栈根据这个描述符来判断到底使用哪一个套接字去和服务器端的套接字进行连接，并执行连接的操作 
- 服务器IP地址：就是通过DNS服务器查询得到的我 们要访问的服务器的IP地址
- 端口号：只要知道了IP地址，我们就可以识别出网络上的某台计算机。但是，连接操作的对象是某个具体的套接字，因此必须要识别到具体的套接字才行，而仅凭IP地址是无法做到这一点的。当同时指定IP地址和端口号时，就可以明确识别出某台具体的计算机上的某个具体的套接字

```
描述符：应用程序用来识别套接字的机制 
IP地址和端口号：客户端和服务器之间用来识别对方套接字的机制
```

### 通信阶段：传递消息

只要将数据送入套接字，数据就会被发送到对方的套接字中。当然，应用程序无法直接控制套接字，因此还是要通过Socket库委托协议栈来完成这个操作。这个操作需要使用write这个程序组件

首先，应用程序需要在内存中准备好要发送的数据。根据用户输入的 网址生成的HTTP请求消息就是我们要发送的数据。接下来，当调用write 时，需要指定**描述符**和**发送数据**， 然后协议栈就会将数据发送 到服务器。由于套接字中已经保存了已连接的通信对象的相关信息，所以 只要通过描述符指定套接字，就可以识别出通信对象，并向其发送数据。 接着，发送数据会通过网络到达我们要访问的服务器。 

当消息返回后，需要执行的是接收消息的操作。接收消息的操作是通 过 Socket 库中的read 程序组件委托协议栈来完成的。 调用 read时需要指定用于存放接收到的响应消息的内存地址，这一内存地址称 为**接收缓冲区**。于是，当服务器返回响应消息时，read就会负责将接收到 的响应消息存放到接收缓冲区中。由于接收缓冲区是一块位于应用程序内 部的内存空间，因此当消息被存放到接收缓冲区中时，就相当于已经转交 给了应用程序。

### 断开阶段：收发数据结束

我们需 要调用Socket库的close程序组件进入断开阶段。 最终，连接 在套接字之间的管道会被断开，套接字本身也会被删除。

Web 使用的HTTP协议规定，当Web 服务器发送完 响应消息之后，应该主动执行断开操作 A，因此Web 服务器会首先调用 close来断开连接。断开操作传达到客户端之后，客户端的套接字也会进入 断开阶段。接下来，当浏览器调用read执行接收数据操作时，read会告知 浏览器收发数据操作已结束，连接已经断开。浏览器得知后，也会调用 close进入断开阶段。 

HTTP协议将HTML文档和图片都作为单 独的对象来处理，每获取一次数据，就要执行一次连接、发送请求消息、 接收响应消息、断开的过程。因此，如果一个网页中包含很多张图片，就 必须重复进行很多次连接、收发数据、断开的操作。对于同一台服务器来 说，重复连接和断开显然是效率很低的，因此后来人们又设计出了能够在 一次连接中收发多个请求和响应的方法。在HTTP版本1.1中就可以使用 这种方法，在这种情况下，当所有数据都请求完成后，浏览器会主动触发 断开连接的操作。

## 2.1 创建套接字

### 协议栈的内部结构

本章我们将探索操作系统中的网络控制软件（协议栈）和网络硬件（网 卡）是如何将浏览器的消息发送给服务器的。

![2.1.1TCPIP软件采用分层结构](D:\编程学习\MD笔记\网络是怎么样连接的\2.1.1TCPIP软件采用分层结构.PNG)

- 最上面的部分是网络应用程序序，它们会将收发数据等工作委派给下层的部分来完成
- 应用程序的下面是Socket 库，其中包括解析器，解析器用来向DNS 服务器发出查询
- 再下面就是操作系统内部了，其中包括协议栈。协议栈的上半部分有 两块，分别是负责用TCP协议收发数据的部分和负责用UDP协议收发数 据的部分，它们会接受应用程序的委托执行收发数据的操作

```
像浏 览器、邮件等一般的应用程序都是使用TCP收发数据的，而像DNS查询 等收发较短的控制数据的时候则使用UDP。
```

- 下面一半是用IP协议控制网络包收发操作的部分。此外，IP 中还包括ICMPA 协议和ARPB 协议。 ICMP用于告知网络包传送过程中产生的错误以及各种控制消息，ARP用 于根据IP地址查询相应的以太网MAC地址 C。 

### 套接字的实体就是通信控制信息

什么是套接字？

在协议栈内部有一块用于存放控制信息的内存空间，这里记录了用于 控制通信操作的控制信息，例如通信对象的IP地址、端口号、通信操作的 进行状态等。本来套接字就只是一个概念而已，并不存在实体，如果一定 要赋予它一个实体，我们可以说这些控制信息就是套接字的实体，或者说 存放控制信息的内存空间就是套接字的实体。

```
协议栈是根据套接字中记录的控制信息来工作的
```

![image-20210221213346617](D:\编程学习\MD笔记\网络是怎么样连接的\2.1.2套接字内容.PNG)

### 调用socket时的操作

![image-20210221213805338](D:\编程学习\MD笔记\网络是怎么样连接的\2.1.3消息收发操作.PNG)

我们来看一下浏览器通过Socket库向协议栈发出委托的一系列操作

首先是创建套接字的阶段。应用程序调用socket申请创建套接字，协议栈根据应用程序的申请执行创建套接字的操作

```
创建套接字时，首先分配一个套接字所需的内存空间，然后向其中写入初始状态
```

接下来，需要将表示这个套接字的描述符告知应用程序，应用程序程序通过描述符调用对应的套接字。由于套接字中记录了通信双方的信息以及通信处于怎样的 状态，所以只要通过描述符确定了相应的套接字，协议栈就能够获取所有 的相关信息。

## 2.2 连接服务器

### 连接的含义

创建套接字之后，应用程序（浏览器）就会调用connect，随后协议栈 会将本地的套接字与服务器的套接字进行连接。

连接实际上是通信双方交换控制信息，在套接字中记 录这些必要信息并准备数据收发的一连串操作。

此外，当执行数据收发操作时，我们还需要一块用来临时存放 要收发的数据的内存空间，这块内存空间称为缓冲区，它也是在连接操作 的过程中分配的

### 负责保存控制信息的头部

控制信息分类

- 客户端和服务器相互联络时交换的控制信息，如TCP头部、以太网头部、IP头部

  ![image-20210222102756074](D:\编程学习\MD笔记\网络是怎么样连接的\2.2.1TCP头部信息.PNG)

  ![image-20210222103039012](D:\编程学习\MD笔记\网络是怎么样连接的\2.2.2客户端和服务器之间交换信息.PNG)

- 保存在套接字中，用来控制协议栈操作的信息。应用程序传递来的信息以及从通信对象接收到的信息都会保存在这里，还有收发数据操作的执行状态等信息也会保存在这里，协议栈会根据这些信息来执行每一步的操作。我们可以说，套接字的控制信息和协 议栈的程序本身其实是一体的。

```
通信操作中使用的控制信息分为两类。 
（1） 头部中记录的信息 
（2） 套接字（协议栈中的内存空间）中记录的信息
```

### 连接操作的实际过程

```
connect（<描述符>, <服务器IP地址和端口号>, …）
```

上面的调用提供了服务器的IP地址和端口号，这些信息会传递给协议栈中的TCP模块。然后，TCP模块会与该IP地址对应的对象，也就是与服务器的TCP 模块交换控制信息。



```
连接操作的第一步是在TCP模块处创建表示连接控制信息的头部

通过TCP头部中的发送方和接收方端口号可以找到要连接的套接字。
```

具体阐述

- 首先，客户端先创建一个包含表示开始数据收发操作的控制信息的头部。头部包含很多字段，这里要关注的重点是发送方和接收方的 端口号

- 到这里，客户端（发送方）的套接字就准确找到了服务器（接收 方）的套接字，也就是搞清楚了我应该连接哪个套接字

- 然后，我们将头 部中的控制位的SYN比特设置为1，大家可以认为它表示连接 A。此外还需要设置适当的序号和窗口大小

  

  *2.3（使用ACk确认网络包已收到）将控制为SYN比特设置为1是在这一步将序号的初始值告知对方的。实 际上，在将SYN设为1的同时，还需要同时设置序号字段的值，而这里的 值就代表序号的初始值*

  

当TCP头部创建好之后，接下来TCP模块会将信息传递给IP模块并委托它进行发送 ，发送过程如下

- IP模块执行网络包发送操作后，网络包就会通过网络到 达服务器，然后服务器上的IP 模块会将接收到的数据传递给TCP 模块
- 服务器的TCP模块根据TCP头部中的信息找到端口号对应的套接字，也 就是说，从处于等待连接状态的套接字中找到与TCP头部中记录的端口号 相同的套接字就可以了
- 当找到对应的套接字之后，套接字中会写入相应的信息，并将状态改为正在连接 
- 上述操作完成后，服务器的TCP模块会 返回响应，这个过程和客户端一样，需要在TCP头部中设置发送方和接收 方端口号以及SYN比特 
- 此外，在返回响应时还需要将ACK控制位设为 1，这表示已经接收到相应的网络包。网络中经常会发生错误，网络包也会 发生丢失，因此双方在通信时必须相互确认网络包是否已经送达 E，而设置 ACK比特就是用来进行这一确认的。
- 接下来，服务器TCP模块会将TCP 头部传递给IP模块，并委托IP模块向客户端返回响应

之后服务器的信息就返回到了客户端

- 网络包就会返回到客户端，通过IP模块到达TCP模块，并通 过TCP头部的信息确认连接服务器的操作是否成功
- 如果SYN为1则表示连接成功，这时会向套接字中写入服务器的IP地址、端口号等信息，同时还会将状态改为连接完毕
- 刚才服务器返回响应时将ACK比特设置为1，相应地， 客户端也需要将ACK比特设置为1并发回服务器，告诉服务器刚才的响应包已经收到

## 2.3 收发数据

### 将HTTP请求消息交给协议栈

当控制流程从connect回到应用程序之后，接下来就进入数据收发阶段了。数据收发操作是从应用程序调用write将要发送的数据交给协议栈开始的（图2.3③）， 协议栈收到数据后执行发送操作

协议栈并不关心应用程序传来的数据是什么内容。应用程序在 调用write时会指定发送数据的长度，在协议栈看来，要发送的数据就是 一定长度的二进制字节序列而已

协议栈并不是一收到数据就马上发送出去，而是会将数据存放 在内部的发送缓冲区中，并等待应用程序的下一段数据。如果一收到数据就马上发送出去，就可能会发送大量的小包，导致网络效 率下降，因此需要在数据积累到一定量时再发送出去。至于要积累多少数据才能发送。不同种类和版本的操作系统会有所不同，不能一概而论，但 都是根据下面几个要素来判断的。 

- 每个网络包能容纳的数据长度：MTUA 的参数来进行判断。MTU表示一个网络包的最大长度，在以太 网中一般是1500字节（图2.5）B。MTU是包含头部的总长度，因此需要从 MTU减去头部的长度，然后得到的长度就是一个网络包中所能容纳的最大 数据长度，这一长度叫作MSSC。当从应用程序收到的数据长度超过或者接 近MSS时再发送出去，就可以避免发送大量小包的问题了。

  ```
  MTU：一个网络包的最大长度，以太网中一般为 1500 字节。
  MSS：除去头部之后，一个网络包所能容纳的TCP数据的最大 长度。
  ```

  

- 时间：协议栈的内部有一个计时器，当经过一定时间之后， 就会把网络包发送出去 

![image-20210222112452709](D:\编程学习\MD笔记\网络是怎么样连接的\2.3.1MTU与MSS.PNG)

### 对较大数据进行拆分

当应用程序提交的数据很大，发送缓冲区中的数据就会超过MSS的长度，这时我们当 然不需要继续等待后面的数据了。发送缓冲区中的数据会被以MSS长度为 单位进行拆分，拆分出来的每块数据会被放进单独的网络包中。 

![image-20210222112723709](D:\编程学习\MD笔记\网络是怎么样连接的\应用程序数据的拆分发送.PNG)

### 使用ACK确认网络包已收到

。TCP具备确认对方是否成功收到网络包，以及当对方没收到时进 行重发的功能，因此在发送网络包之后，接下来还需要进行确认操作。 

- 首先，TCP模块在拆分数据时， 会先算好每一块数据相当于从头开始的第几个字节，接下来在发送这一块 数据时，将算好的字节数写在TCP头部中，“ 序号”字段就是派在这个用 场上的
- 然后，发送数据的长度也需要告知接收方，不过这个并不是放在 TCP头部里面的，因为用整个网络包的长度减去头部的长度就可以得到数据的长度

有了上面两个数值， 我们就可以知道发送的数据是从第几个字节开始，长度是多少了。 

通过这些信息，接收方还能够检查收到的网络包有没有遗漏

简单来说，发送方说的是“现在发送的 是从第×× 字节开始的部分，一共有×× 字节哦！” 而接收方则回复说， “到第×× 字节之前的数据我已经都收到了哦！” 这个返回ACK号的操 作被称为确认响应，通过这样的方式，发送方就能够确认对方到底收到 了多少数据。

![image-20210222113708470](D:\编程学习\MD笔记\网络是怎么样连接的\2.3.2序号和ACK号的用法.PNG)

![image-20210222114403008](D:\编程学习\MD笔记\网络是怎么样连接的\2.3.3序号和ACK号的交互.PNG)

这一机制非常强大。通过这一机制，我们可以确认接收方有没有收到 某个包，如果没有收到则重新发送，这样一来，无论网络中发生任何错误， 我们都可以发现并采取补救措施（重传网络包）。 反过来说，有了这一机 制，我们就不需要在其他地方对错误进行补救了。

因此，网卡、集线器、路由器都没有错误补偿机制，一旦检测到错误 就直接丢弃相应的包。

### 使用窗口管理ACK号的等待时间

根据服务器物理距离的远近，ACK号的返回时间也会产生很大的 波动，而且我们还必须考虑到拥塞带来的影响。

TCP采用了动态调整等待时间的方法，这个等待时间是 根据ACK号返回所需的时间来判断的。具体来说，TCP会在发送数据 的过程中持续测量ACK号的返回时间，如果ACK号返回变慢，则相应 延长等待时间；相对地，如果ACK号马上就能返回，则相应缩短等待 时间 B。

所谓滑动窗口，就是在发送一 个包之后，不等待ACK号返回，而是直接发送后续的一系列包。这样一 来，等待ACK号的这段时间就被有效利用起来了

![image-20210222114845818](D:\编程学习\MD笔记\网络是怎么样连接的\2.3.4一来一回的方式与滑动窗口的方式.PNG)

接收方需要告诉发送方自己最多能接收多少数据， 然后发送方根据这个值对数据发送操作进行控制，这就是滑动窗口方式的 基本思路

![image-20210222115239591](D:\编程学习\MD笔记\网络是怎么样连接的\2.3.5滑动窗口与接受缓存区.PNG)

```
前面提到的能够接收的最大数据量称为窗口大小 A，它是TCP调优参数 中非常有名的一个
```

### ACK与窗口合并使用

要提高收发数据的效率，还需要考虑另一个问题，那就是返回ACK 号和更新窗口的时机

首先是更新窗口时机的选择

- 因此当接收方将数据传递给应用程序，冲区时，其实没必要每次都向发送方更新窗口大小，因为只要发送方在每 次发送数据时减掉已发送的数据长度就可以自行计算出当前窗口的剩余长 度。
- 导致接收缓冲区剩余容量增加时，就需要告知发送方，这就是更 新窗口大小的时机

ACK号又是什么情况呢

- 当接收方收到数据时，如果确认内容 没有问题，就应该向发送方返回ACK号，因此我们可以认为收到数据之 后马上就应该进行这一操作

那么如何优化呢？

接收方在发送ACK号和窗口更新时，并不会马上把包发送出 去，而是会等待一段时间，在这个过程中很有可能会出现其他的通知操作， 这样就可以把两种通知合并在一个包里面发送了

- 例1：在等待发送 ACK号的时候正好需要更新窗口，这时就可以把ACK号和窗口更新放在 一个包里发送，从而减少包的数量
- 等待时间内有连续多个ACK号，只需发最后一个
- 等待时间内有连续多个窗口更新，只需发最后一个

### 接收HTTP响应消息

